const mineflayer = require('mineflayer');
const sqlite3 = require('sqlite3').verbose();

let db;

module.exports = bot => {
    db = new sqlite3.Database('custom_commands.db', err => {
        if (err) {
            console.error(err.message);
        } else {
            console.log('Connected to the SQLite database.');
            db.run(`CREATE TABLE IF NOT EXISTS custom_commands (
                id INTEGER PRIMARY KEY,
                command_name TEXT UNIQUE,
                response TEXT
            )`, (err) => {
                if (err) {
                    console.error(err.message);
                } else {
                    console.log('Table created successfully.');
                }
            });
        }
    });
    
    bot.on('chat', (username, message) => {
        if (message.startsWith('addcmd')) {
            const args = message.split(' ');
            const command = args[1];
            const response = args.slice(2).join(' ');
            
            db.run('INSERT INTO custom_commands (command_name, response) VALUES (?, ?)', [command, response], (err) => {
                if (err) {
                    console.error(err.message);
                    return;
                }
                bot.chat(`Command '${command}' added successfully!`);
                console.log(`Command '${command}' added successfully!`);
            });
        } else if (message.startsWith('listcmds')) {
            db.all('SELECT command_name FROM custom_commands', [], (err, rows) => {
                if (err) {
                    console.error(err.message);
                    return;
                }
                rows.forEach((row) => {
                    bot.chat(row.command_name);
                });
            });
        } else if (message.startsWith('delcmd')) {
            const args = message.split(' ');
            const commandToDelete = args[1];
            
            db.run('DELETE FROM custom_commands WHERE command_name = ?', [commandToDelete], (err) => {
                if (err) {
                    console.error(err.message);
                    return;
                }
                bot.chat(`Command '${commandToDelete}' deleted successfully!`);
                console.log(`Command '${commandToDelete}' deleted successfully!`);
            });
        } else if (message.startsWith('!')) {
            const command = message.substring(1); // Extract command name from message
            
            db.get('SELECT response FROM custom_commands WHERE command_name = ?', [command], (err, row) => {
                if (err) {
                    console.error(err.message);
                    return;
                }
                
                if (row) {
                    bot.chat(row.response);
                } else {
                    console.log(`Command '${command}' not found.`);
                }
            });
        }
    });
};
